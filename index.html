<script>
  // ---- Configuración base ----
  const BACKEND_BASE_URL =
    window.NEXT_PUBLIC_BACKEND_BASE_URL ||
    window.BACKEND_BASE_URL ||
    'https://infinium-chat-api.vercel.app';

  const CHAT_API_URL = `${BACKEND_BASE_URL}/api/chat`;
  const EVENT_API_URL = `${BACKEND_BASE_URL}/api/event`;
  const pagePath = `${window.location.pathname}${window.location.search}`;
  const SESSION_STORAGE_KEY = 'infinium_session_id';

  // ---- Referencias DOM ----
  const socialToggle = document.getElementById('socialToggle');
  const socialPanel = document.getElementById('socialPanel');
  const compraBtn = document.getElementById('btn-compra');
  const whatsappEsBtn = document.getElementById('btn-whatsapp-es');
  const whatsappEnBtn = document.getElementById('btn-whatsapp-en');

  const quickButtons = Array.from(document.querySelectorAll('.quick-button'));
  const chatOpenButtons = Array.from(document.querySelectorAll('[data-chat-open="true"]'));
  const moodCards = Array.from(document.querySelectorAll('.mood-card')); // puede estar vacío y no pasa nada
  const moodChatButtons = Array.from(document.querySelectorAll('.mood-action[data-chat-open="true"]')); // opcional

  const chatToggle = document.getElementById('chatToggle');
  const chatModal = document.getElementById('chatModal');
  const chatMessages = document.getElementById('chatMessages');
  const chatForm = document.getElementById('chatForm');
  const chatInput = document.getElementById('chatInput');
  const chatClose = document.getElementById('chatClose');
  const chatStatus = document.getElementById('chatStatus');
  const chatSendButton = document.querySelector('.chat-send');

  // ---- UTM tracking ----
  const UTM_KEYS = ['utm_source', 'utm_medium', 'utm_campaign', 'utm_content', 'utm_term'];
  const urlParams = new URLSearchParams(window.location.search);

  const persistUtmFromUrl = () => {
    UTM_KEYS.forEach((key) => {
      const value = urlParams.get(key);
      if (value) sessionStorage.setItem(key, value);
    });
  };

  const readUtmFromSession = () => {
    const data = {};
    UTM_KEYS.forEach((key) => {
      const stored = sessionStorage.getItem(key);
      if (stored) data[key] = stored;
    });
    return data;
  };

  persistUtmFromUrl();
  const utmData = readUtmFromSession();

  const hasTrackingDetails = Boolean(
    utmData.utm_source || utmData.utm_campaign || utmData.utm_content
  );

  // ---- GA4 helpers ----
  const sendGAEventSafely = (eventName, eventParams = {}) => {
    if (typeof gtag === 'function') {
      const gaParams = {
        ...eventParams,
        ...(utmData.utm_source ? { utm_source: utmData.utm_source } : {}),
        ...(utmData.utm_campaign ? { utm_campaign: utmData.utm_campaign } : {}),
        ...(utmData.utm_content ? { utm_content: utmData.utm_content } : {}),
        page: pagePath
      };
      gtag('event', eventName, gaParams);
    }
  };

  // ---- Session ----
  const getSessionId = () => {
    const existing = localStorage.getItem(SESSION_STORAGE_KEY);
    if (existing) return existing;

    const generated =
      (typeof crypto !== 'undefined' && crypto.randomUUID)
        ? crypto.randomUUID()
        : `inf-${Date.now()}-${Math.random().toString(16).slice(2)}`;

    localStorage.setItem(SESSION_STORAGE_KEY, generated);
    return generated;
  };

  const sessionId = getSessionId();

  // ---- Meta data ----
  const buildMeta = () => ({
    site_id: urlParams.get('s') || '',
    team_id: urlParams.get('t') || '',
    campaign_id: urlParams.get('c') || '',
    page: pagePath,
    ts: new Date().toISOString()
  });

  // ---- Event pipeline ----
  const postEvent = (eventName, data = {}) => {
    const payload = {
      event: eventName,
      sessionId,
      meta: buildMeta(),
      data
    };

    fetch(EVENT_API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    }).catch((error) => console.warn('[EVENT PIPELINE] Error al enviar evento', error));
  };

  const trackEvent = (eventName, extra = {}) => {
    sendGAEventSafely(eventName, extra);
    postEvent(eventName, extra);
  };

  // ---- Backend health ----
  const setBackendStatus = (isOk) => {
    if (!chatStatus) return;
    const healthy = Boolean(isOk);
    window.__backendOk = healthy;
    chatStatus.textContent = healthy ? 'Asistente en línea ✅' : 'Reconectando…';
    chatStatus.classList.toggle('ok', healthy);
    chatStatus.classList.toggle('error', !healthy);
  };

  const checkBackend = async () => {
    try {
      const response = await fetch(`${BACKEND_BASE_URL}/api/ping`);
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      const data = await response.json();
      const isOk = data?.ok === true;
      setBackendStatus(isOk);
      return isOk;
    } catch (error) {
      console.error('[CHAT] ping fail', error);
      setBackendStatus(false);
      return false;
    }
  };

  // ---- WhatsApp ----
  const buildWhatsAppMessage = () => {
    const baseText = 'Hola, vengo de INFINIUM y quiero asesoría.';
    if (!hasTrackingDetails) return baseText;

    const source = utmData.utm_source || 'direct';
    const campaign = utmData.utm_campaign || 'generic';
    const content = utmData.utm_content || 'default';

    return `${baseText} Origen: ${source}. Campaña: ${campaign}. Contenido: ${content}.`;
  };

  const updateWhatsAppHref = (element, baseUrl, lang) => {
    if (!element) return;
    const url = new URL(baseUrl);
    url.searchParams.set('text', buildWhatsAppMessage());
    element.href = url.toString();
    element.dataset.lang = lang;
  };

  updateWhatsAppHref(whatsappEsBtn, 'https://wa.me/19565505115', 'es');
  updateWhatsAppHref(whatsappEnBtn, 'https://wa.me/19564421379', 'en');

  // ---- UI listeners ----
  const sendCtaClick = (ctaType, url) => {
    trackEvent('cta_click', { cta: ctaType, url });
  };

  if (socialToggle && socialPanel) {
    socialToggle.addEventListener('click', () => {
      const isOpen = socialPanel.classList.toggle('open');
      socialToggle.setAttribute('aria-expanded', String(isOpen));
    });
  }

  if (compraBtn) {
    compraBtn.addEventListener('click', () => sendCtaClick('buy', compraBtn.href || ''));
  }

  [whatsappEsBtn, whatsappEnBtn].forEach((btn) => {
    if (!btn) return;
    btn.addEventListener('click', () => sendCtaClick('whatsapp', btn.href || ''));
  });

  // ---- Chat UI ----
  const appendMessage = (text, type = 'bot', actions = []) => {
    if (!chatMessages) return;

    const div = document.createElement('div');
    div.className = `chat-message ${type}`;
    div.textContent = text;
    chatMessages.appendChild(div);

    if (Array.isArray(actions) && actions.length > 0) {
      const actionsContainer = document.createElement('div');
      actionsContainer.className = 'chat-actions';

      actions.forEach((action) => {
        const actionBtn = document.createElement('button');
        actionBtn.type = 'button';
        actionBtn.className = 'chat-action-button';
        actionBtn.textContent = action.label || 'Acción';

        actionBtn.addEventListener('click', () => {
          if (action.type === 'open_url' && action.url) {
            sendCtaClick('buy', action.url);
            window.open(action.url, '_blank', 'noopener,noreferrer');
          } else if (action.type === 'whatsapp' && action.phone) {
            const phoneDigits = String(action.phone || '').replace(/\D/g, '');
            const waUrl = `https://wa.me/${phoneDigits}?text=${encodeURIComponent(action.text || '')}`;
            sendCtaClick('whatsapp', waUrl);
            window.open(waUrl, '_blank', 'noopener,noreferrer');
          } else if (action.url) {
            sendCtaClick('join', action.url);
            window.open(action.url, '_blank', 'noopener,noreferrer');
          }
        });

        actionsContainer.appendChild(actionBtn);
      });

      chatMessages.appendChild(actionsContainer);
    }

    chatMessages.scrollTop = chatMessages.scrollHeight;
  };

  const setChatLoading = (isLoading) => {
    if (chatSendButton) chatSendButton.disabled = isLoading;
    if (chatInput) chatInput.disabled = isLoading;
  };

  // ---- OpenChat único (sin duplicados) ----
  window.INFINIUM = window.INFINIUM || {};
  window.INFINIUM.openChat = function () {
    if (!chatModal || !chatToggle) return false;

    if (!chatModal.classList.contains('open')) {
      chatModal.classList.add('open');
      chatToggle.setAttribute('aria-expanded', 'true');
      checkBackend();
      chatInput?.focus();
    } else {
      chatInput?.focus();
    }
    return true;
  };

  const handleChatToggle = () => {
    if (!chatModal || !chatToggle) return;
    const isOpen = chatModal.classList.toggle('open');
    chatToggle.setAttribute('aria-expanded', String(isOpen));
    if (isOpen) {
      checkBackend();
      chatInput?.focus();
    }
  };

  const openChatAndFocus = () => {
    if (window.INFINIUM?.openChat) window.INFINIUM.openChat();
  };

  const prefillChatInput = (message) => {
    if (!message) return;
    openChatAndFocus();
    if (chatInput) {
      chatInput.value = message;
      chatInput.focus();
    }
  };

  if (chatToggle) chatToggle.addEventListener('click', handleChatToggle);
  if (chatClose) chatClose.addEventListener('click', handleChatToggle);

  if (chatForm) {
    chatForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const message = chatInput?.value.trim();
      if (!message) return;

      appendMessage(message, 'user');
      chatInput.value = '';
      setChatLoading(true);

      try {
        const payload = { message, sessionId, meta: buildMeta(), quick: false };

        const response = await fetch(CHAT_API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const data = await response.json();
        const reply = data?.reply || 'Estamos recibiendo tu mensaje...';
        appendMessage(reply, 'bot', data?.actions || []);
        trackEvent('chat_message_sent', { length: message.length });
      } catch (error) {
        console.error('[CHAT] error', error);
        appendMessage('Hubo un problema al responder. Intenta nuevamente en unos segundos.', 'bot');
      } finally {
        setChatLoading(false);
      }
    });
  }

  quickButtons.forEach((button) => {
    button.addEventListener('click', () => {
      const suggestion = button.dataset.prefill || '';
      prefillChatInput(suggestion);
      trackEvent('quick_topic_click', { label: button.textContent?.trim() || '' });
    });
  });

  chatOpenButtons.forEach((button) => {
    button.addEventListener('click', () => {
      openChatAndFocus();
      trackEvent('chat_open_click', { label: button.textContent?.trim() || '' });
    });
  });

  // Mood cards (si existen)
  moodCards.forEach((card) => {
    const handleMoodSelect = () => {
      const message = card.dataset.prefill || '';
      prefillChatInput(message);
      trackEvent('mood_card_click', { message });
    };

    card.addEventListener('click', handleMoodSelect);
    card.addEventListener('keydown', (event) => {
      if (event.key === 'Enter' || event.key === ' ') {
        event.preventDefault();
        handleMoodSelect();
      }
    });
  });

  moodChatButtons.forEach((button) => {
    button.addEventListener('click', () => {
      openChatAndFocus();
      trackEvent('mood_quick_action_click', { label: button.textContent?.trim() || '' });
    });
  });

  // ---- Init ----
  appendMessage('Hola, soy el asistente de INFINIUM. ¿En qué puedo ayudarte hoy?', 'bot');
  checkBackend();
  console.log('[INFINIUM] boot ok', {
    chatToggle: !!chatToggle,
    chatModal: !!chatModal,
    openBtns: chatOpenButtons.length
  });
</script>
